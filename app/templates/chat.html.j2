{% extends "base.html.j2" %}
{% block title %}CVbot â€” Interview{% endblock %}

{% block body %}
<div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h5 class="sidebar-brand"><i class="bi bi-robot me-2"></i>CVbot</h5>
            <button class="btn btn-sm btn-outline-light d-md-none" id="closeSidebar">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <button class="btn btn-primary w-100 mb-3" id="newChatBtn">
            <i class="bi bi-plus-lg me-1"></i> New Interview
        </button>

        <div class="mb-3">
            <select class="form-select form-select-sm" id="candidateSelect">
                {% for c in candidates %}
                <option value="{{ c['id'] }}">{{ c['display_name'] }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="sidebar-search mb-2">
            <input type="text" class="form-control form-control-sm" placeholder="Search threads..." id="searchThreads">
        </div>

        <nav class="conversation-list" id="conversationList">
            {% for conv in conversations %}
            <a href="/chat/{{ conv['id'] }}"
               class="conversation-item {% if active_conversation and active_conversation['id'] == conv['id'] %}active{% endif %}"
               data-id="{{ conv['id'] }}">
                <span class="conv-title">{{ conv['title'] or 'New Interview' }}</span>
                <span class="conv-actions">
                    <button class="btn btn-sm btn-link text-muted rename-conv p-0" data-id="{{ conv['id'] }}">
                        <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="btn btn-sm btn-link text-muted delete-conv p-0" data-id="{{ conv['id'] }}">
                        <i class="bi bi-trash3"></i>
                    </button>
                </span>
            </a>
            {% endfor %}
        </nav>

        <div class="sidebar-footer">
            <a href="/work-experience" class="btn btn-sm btn-outline-secondary w-100 mb-2">
                <i class="bi bi-briefcase me-1"></i> Work Experience
            </a>
            <a href="/job-fit" class="btn btn-sm btn-outline-secondary w-100 mb-2">
                <i class="bi bi-clipboard-check me-1"></i> Job Fit Analysis
            </a>
            <a href="/costs" class="btn btn-sm btn-outline-secondary w-100">
                <i class="bi bi-graph-up me-1"></i> Cost Dashboard
            </a>
            <button class="btn btn-sm btn-outline-secondary w-100 mt-2" id="themeToggle">
                <i class="bi bi-moon-stars me-1"></i> Toggle Theme
            </button>
        </div>
    </aside>

    <!-- Main -->
    <main class="chat-main">
        <div class="chat-topbar">
            <button class="btn btn-sm btn-outline-secondary d-md-none me-2" id="openSidebar">
                <i class="bi bi-list"></i>
            </button>
            <span class="topbar-title"><i class="bi bi-robot me-2"></i>
                {% if active_conversation %}
                    {{ active_conversation['candidate_name'] }}
                {% else %}
                    CVbot
                {% endif %}
            </span>
            <div class="ms-auto d-flex align-items-center gap-3">
                <div class="usage-summary usage-summary-inline" id="chatUsageSummary">
                    <div class="usage-summary-meta">
                        Daily Limit <span id="chatUsageTokenText">0 in / 0 out tokens</span>
                    </div>
                    <div class="progress usage-progress" role="progressbar" aria-label="Cost usage">
                        <div class="progress-bar" id="chatUsageProgressBar" style="width: 0%"></div>
                    </div>
                    <div class="usage-progress-labels">
                        <span id="chatUsageCurrentCost">$0.00</span>
                        <span id="chatUsageMaxCost">${{ '%.2f'|format(daily_limit_usd) }}</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages">
            {% if not active_conversation %}
            <div class="welcome-screen">
                <h2>How can I help you?</h2>
                <p class="text-muted">Select a candidate and start an interview to explore their work experience.</p>
            </div>
            {% else %}
                {% for msg in messages %}
                <div class="message message-{{ msg['role'] }}"{% if msg['role'] == 'user' %} data-message-id="{{ msg['id'] }}"{% endif %}>
                    <div class="message-content">{{ msg['content'] }}</div>
                    {% if msg['role'] == 'user' %}
                    <button class="btn btn-link btn-sm edit-message p-0 mt-1 text-white" data-message-id="{{ msg['id'] }}">
                        <i class="bi bi-pencil-square"></i>
                    </button>
                    {% endif %}
                </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="chat-input-area">
            <div class="chat-input-wrapper">
                <textarea class="form-control" id="chatInput" placeholder="Type your message here..."
                          rows="1" {% if not active_conversation %}disabled{% endif %}></textarea>
                <div class="chat-input-toolbar">
                    <select class="input-model-select" id="modelSelect">
                        {%- for model_key in models %}
                        <option value="{{model_key}}">{{models[model_key]}}</option>
                        {%- endfor %}
                    </select>
                    <button class="btn btn-primary send-btn" id="sendBtn"
                            {% if not active_conversation %}disabled{% endif %}>
                        <i class="bi bi-arrow-up"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="/static/js/chat.js"></script>
{% endblock %}
